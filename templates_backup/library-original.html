<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>翻译库管理 - Monolith 网页翻译器</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <style>
        /* Library 专用样式 */
        .library-page {
            background: #f5f5f5;
            min-height: 100vh;
            padding-top: 60px;
        }
        
        .library-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-bottom: 4px solid #667eea;
        }
        
        .page-title {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        /* 工具栏 */
        .toolbar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }
        
        .toolbar-left {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .toolbar-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-box {
            position: relative;
            min-width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: #666;
        }
        
        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e1e5e9;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        /* 数据表格 */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .table-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .table-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
        .data-table th {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #5a6fd8;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table th:first-child {
            width: 50px;
            text-align: center;
        }
        
        .data-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .data-table th.sortable:hover {
            background: #5a6fd8;
        }
        
        .data-table th.sortable::after {
            content: '↕';
            position: absolute;
            right: 0.5rem;
            opacity: 0.6;
        }
        
        .data-table th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }
        
        .data-table th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #e1e5e9;
            vertical-align: middle;
        }
        
        .data-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tbody tr.selected {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .checkbox-cell {
            text-align: center;
            width: 50px;
        }
        
        .custom-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .url-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .url-link {
            color: #667eea;
            text-decoration: none;
        }
        
        .url-link:hover {
            text-decoration: underline;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-success {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }
        
        .status-pending {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }
        
        .status-error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        .language-tag {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
        
        /* 分页 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .pagination-info {
            color: #666;
            font-size: 0.9rem;
        }
        
        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .page-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e1e5e9;
            background: white;
            color: #666;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .page-btn:hover {
            background: #f8f9fa;
            border-color: #667eea;
            color: #667eea;
        }
        
        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .library-container {
                padding: 1rem;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .toolbar-left,
            .toolbar-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-box {
                min-width: auto;
                width: 100%;
            }
            
            .data-table {
                font-size: 0.8rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 0.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .page-header {
                padding: 1rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 置顶导航栏 -->
    <nav class="navbar" id="navbar">
        <!-- 隐藏/显示按钮 -->
        <button class="toggle-nav-btn" id="toggle-nav-btn" title="隐藏导航栏">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
            </svg>
        </button>

        <!-- 返回主页链接 -->
        <a href="/" class="nav-btn" title="返回翻译首页">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            <span>翻译首页</span>
        </a>

        <!-- 页面标题 -->
        <div style="flex: 1; text-align: center;">
            <h1 style="color: #667eea; font-size: 1.2rem; margin: 0;">翻译库管理</h1>
        </div>

        <!-- 导航按钮组 -->
        <div class="nav-actions">
            <!-- 书签脚本链接 -->
            <a href="/bookmarklet" class="nav-btn" title="书签脚本" target="_blank">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
                </svg>
                <span>书签</span>
            </a>
            
            <!-- 设置链接 -->
            <a href="/settings" class="nav-btn" title="系统设置">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
                <span>设置</span>
            </a>
        </div>
    </nav>

    <!-- 悬浮显示按钮 -->
    <button class="floating-toggle" id="floating-toggle" title="显示导航栏">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
    </button>

    <!-- 主内容区域 -->
    <div class="library-page">
        <div class="library-container">
            <!-- 页面头部 -->
            <header class="page-header">
                <div class="page-title">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 32px; height: 32px;">
                        <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/>
                    </svg>
                    翻译库管理中心
                </div>
                <p class="page-subtitle">
                    管理所有已翻译的网页内容，支持查看、搜索、编辑和删除操作。可按日期、语言和状态进行筛选。
                </p>
                
                <!-- 统计数据 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number" id="total-count">0</span>
                        <div class="stat-label">总翻译数</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="success-count">0</span>
                        <div class="stat-label">成功翻译</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="today-count">0</span>
                        <div class="stat-label">今日翻译</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="storage-size">0 MB</span>
                        <div class="stat-label">存储大小</div>
                    </div>
                </div>
            </header>

            <!-- 工具栏 -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <!-- 搜索框 -->
                    <div class="search-box">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="text" class="search-input" id="search-input" placeholder="搜索URL、标题或内容...">
                    </div>
                    
                    <!-- 状态筛选 -->
                    <select class="filter-select" id="status-filter">
                        <option value="">全部状态</option>
                        <option value="success">翻译成功</option>
                        <option value="pending">等待处理</option>
                        <option value="error">翻译失败</option>
                    </select>
                    
                    <!-- 语言筛选 -->
                    <select class="filter-select" id="language-filter">
                        <option value="">全部语言</option>
                        <option value="en">英语</option>
                        <option value="ja">日语</option>
                        <option value="ko">韩语</option>
                        <option value="fr">法语</option>
                        <option value="de">德语</option>
                        <option value="es">西班牙语</option>
                    </select>
                </div>
                
                <div class="toolbar-right">
                    <!-- 批量操作 -->
                    <button class="btn btn-secondary" id="export-btn" title="导出选中项">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        导出
                    </button>
                    <button class="btn btn-danger" id="delete-selected-btn" title="删除选中项">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                        </svg>
                        删除选中
                    </button>
                    <button class="btn btn-primary" id="refresh-btn" title="刷新数据">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                            <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                        </svg>
                        刷新
                    </button>
                </div>
            </div>

            <!-- 数据表格 -->
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">翻译记录列表</h3>
                    <div class="table-actions">
                        <span id="selected-count" style="color: #666; font-size: 0.9rem;">已选择 0 项</span>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="data-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="custom-checkbox" id="select-all">
                                </th>
                                <th class="sortable" data-column="url">原始URL</th>
                                <th class="sortable" data-column="title">页面标题</th>
                                <th class="sortable" data-column="source_lang">源语言</th>
                                <th class="sortable" data-column="target_lang">目标语言</th>
                                <th class="sortable" data-column="status">状态</th>
                                <th class="sortable" data-column="created_at">创建时间</th>
                                <th class="sortable" data-column="file_size">文件大小</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- 数据行将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 空状态 -->
                <div class="empty-state" id="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    <h3>暂无翻译记录</h3>
                    <p>开始翻译网页内容来填充您的翻译库</p>
                    <a href="/" class="btn btn-primary" style="margin-top: 1rem;">开始翻译</a>
                </div>
            </div>

            <!-- 分页 -->
            <div class="pagination" id="pagination">
                <div class="pagination-info">
                    <span id="pagination-info">显示第 1-10 条，共 0 条记录</span>
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" id="prev-page" disabled>上一页</button>
                    <div id="page-numbers">
                        <!-- 页码按钮将通过JavaScript动态生成 -->
                    </div>
                    <button class="page-btn" id="next-page" disabled>下一页</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="assets/js/monolith-translator.js"></script>
    <script>
        class LibraryManager {
            constructor() {
                this.currentPage = 1;
                this.pageSize = 10;
                this.totalRecords = 0;
                this.currentSort = { column: 'created_at', direction: 'desc' };
                this.selectedItems = new Set();
                this.filters = {
                    search: '',
                    status: '',
                    language: ''
                };
                
                this.initElements();
                this.bindEvents();
                this.loadData();
                this.updateStats();
            }

            initElements() {
                // 导航栏相关
                this.navbar = document.getElementById('navbar');
                this.toggleNavBtn = document.getElementById('toggle-nav-btn');
                this.floatingToggle = document.getElementById('floating-toggle');
                
                // 搜索和筛选
                this.searchInput = document.getElementById('search-input');
                this.statusFilter = document.getElementById('status-filter');
                this.languageFilter = document.getElementById('language-filter');
                
                // 表格相关
                this.dataTable = document.getElementById('data-table');
                this.tableBody = document.getElementById('table-body');
                this.selectAllCheckbox = document.getElementById('select-all');
                this.selectedCountSpan = document.getElementById('selected-count');
                this.emptyState = document.getElementById('empty-state');
                
                // 按钮
                this.refreshBtn = document.getElementById('refresh-btn');
                this.exportBtn = document.getElementById('export-btn');
                this.deleteSelectedBtn = document.getElementById('delete-selected-btn');
                
                // 分页
                this.paginationInfo = document.getElementById('pagination-info');
                this.pageNumbers = document.getElementById('page-numbers');
                this.prevPageBtn = document.getElementById('prev-page');
                this.nextPageBtn = document.getElementById('next-page');
                
                // 统计数据
                this.totalCountSpan = document.getElementById('total-count');
                this.successCountSpan = document.getElementById('success-count');
                this.todayCountSpan = document.getElementById('today-count');
                this.storageSizeSpan = document.getElementById('storage-size');
            }

            bindEvents() {
                // 导航栏事件
                this.toggleNavBtn?.addEventListener('click', () => this.toggleNavbar());
                this.floatingToggle?.addEventListener('click', () => this.toggleNavbar());
                
                // 搜索和筛选事件
                this.searchInput.addEventListener('input', this.debounce(() => {
                    this.filters.search = this.searchInput.value;
                    this.currentPage = 1;
                    this.loadData();
                }, 500));
                
                this.statusFilter.addEventListener('change', () => {
                    this.filters.status = this.statusFilter.value;
                    this.currentPage = 1;
                    this.loadData();
                });
                
                this.languageFilter.addEventListener('change', () => {
                    this.filters.language = this.languageFilter.value;
                    this.currentPage = 1;
                    this.loadData();
                });
                
                // 表格事件
                this.selectAllCheckbox.addEventListener('change', () => this.toggleSelectAll());
                
                // 排序事件
                this.dataTable.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', () => {
                        const column = header.dataset.column;
                        this.handleSort(column);
                    });
                });
                
                // 按钮事件
                this.refreshBtn.addEventListener('click', () => this.loadData());
                this.exportBtn.addEventListener('click', () => this.exportSelected());
                this.deleteSelectedBtn.addEventListener('click', () => this.deleteSelected());
                
                // 分页事件
                this.prevPageBtn.addEventListener('click', () => this.changePage(this.currentPage - 1));
                this.nextPageBtn.addEventListener('click', () => this.changePage(this.currentPage + 1));
            }

            toggleNavbar() {
                const navbar = this.navbar;
                const floatingToggle = this.floatingToggle;
                
                navbar.classList.toggle('hidden');
                floatingToggle.classList.toggle('show');
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            async loadData() {
                try {
                    // 显示加载状态
                    this.tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;">加载中...</td></tr>';
                    
                    // 构建查询参数
                    const params = new URLSearchParams({
                        page: this.currentPage,
                        page_size: this.pageSize,
                        sort_column: this.currentSort.column,
                        sort_direction: this.currentSort.direction,
                        ...this.filters
                    });
                    
                    // 发送请求
                    const response = await fetch(`/api/library?${params}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.renderTable(data.records);
                    this.updatePagination(data.total, data.page, data.page_size);
                    this.totalRecords = data.total;
                    
                } catch (error) {
                    console.error('加载数据失败:', error);
                    this.showError('加载数据失败，请稍后重试');
                    this.tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #dc3545;">加载失败</td></tr>';
                }
            }

            renderTable(records) {
                if (!records || records.length === 0) {
                    this.tableBody.innerHTML = '';
                    this.emptyState.style.display = 'block';
                    return;
                }
                
                this.emptyState.style.display = 'none';
                
                this.tableBody.innerHTML = records.map(record => `
                    <tr data-id="${record.id}">
                        <td class="checkbox-cell">
                            <input type="checkbox" class="custom-checkbox row-checkbox" value="${record.id}">
                        </td>
                        <td class="url-cell">
                            <a href="${record.url}" class="url-link" target="_blank" title="${record.url}">
                                ${this.truncateText(record.url, 50)}
                            </a>
                        </td>
                        <td title="${record.title || ''}">
                            ${this.truncateText(record.title || '未知标题', 30)}
                        </td>
                        <td>
                            <span class="language-tag">${record.source_lang?.toUpperCase() || 'AUTO'}</span>
                        </td>
                        <td>
                            <span class="language-tag">${record.target_lang?.toUpperCase() || 'ZH'}</span>
                        </td>
                        <td>
                            <span class="status-badge status-${record.status || 'unknown'}">
                                ${this.getStatusText(record.status)}
                            </span>
                        </td>
                        <td>${this.formatDate(record.created_at)}</td>
                        <td>${this.formatFileSize(record.file_size)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="libraryManager.viewRecord('${record.id}')" title="查看">
                                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
                                        <path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/>
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="libraryManager.downloadRecord('${record.id}')" title="下载">
                                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
                                        <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="libraryManager.deleteRecord('${record.id}')" title="删除">
                                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
                                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                // 绑定行选择事件
                this.tableBody.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', () => this.updateSelection());
                });
            }

            updateSelection() {
                const checkboxes = this.tableBody.querySelectorAll('.row-checkbox');
                this.selectedItems.clear();
                
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        this.selectedItems.add(checkbox.value);
                    }
                });
                
                this.selectedCountSpan.textContent = `已选择 ${this.selectedItems.size} 项`;
                this.selectAllCheckbox.checked = checkboxes.length > 0 && this.selectedItems.size === checkboxes.length;
                this.selectAllCheckbox.indeterminate = this.selectedItems.size > 0 && this.selectedItems.size < checkboxes.length;
            }

            toggleSelectAll() {
                const checkboxes = this.tableBody.querySelectorAll('.row-checkbox');
                const shouldCheck = this.selectAllCheckbox.checked;
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = shouldCheck;
                });
                
                this.updateSelection();
            }

            handleSort(column) {
                if (this.currentSort.column === column) {
                    this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.currentSort = { column, direction: 'asc' };
                }
                
                // 更新排序图标
                this.dataTable.querySelectorAll('.sortable').forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                    if (header.dataset.column === column) {
                        header.classList.add(`sort-${this.currentSort.direction}`);
                    }
                });
                
                this.currentPage = 1;
                this.loadData();
            }

            changePage(page) {
                if (page < 1 || page > Math.ceil(this.totalRecords / this.pageSize)) {
                    return;
                }
                this.currentPage = page;
                this.loadData();
            }

            updatePagination(total, page, pageSize) {
                const totalPages = Math.ceil(total / pageSize);
                
                // 更新分页信息
                const start = (page - 1) * pageSize + 1;
                const end = Math.min(page * pageSize, total);
                this.paginationInfo.textContent = `显示第 ${start}-${end} 条，共 ${total} 条记录`;
                
                // 更新按钮状态
                this.prevPageBtn.disabled = page <= 1;
                this.nextPageBtn.disabled = page >= totalPages;
                
                // 生成页码按钮
                this.generatePageNumbers(page, totalPages);
            }

            generatePageNumbers(currentPage, totalPages) {
                const pageNumbers = this.pageNumbers;
                pageNumbers.innerHTML = '';
                
                const showPages = 5; // 显示的页码数量
                let startPage = Math.max(1, currentPage - Math.floor(showPages / 2));
                let endPage = Math.min(totalPages, startPage + showPages - 1);
                
                if (endPage - startPage < showPages - 1) {
                    startPage = Math.max(1, endPage - showPages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => this.changePage(i));
                    pageNumbers.appendChild(pageBtn);
                }
            }

            async updateStats() {
                try {
                    const response = await fetch('/api/library/stats');
                    if (!response.ok) return;
                    
                    const stats = await response.json();
                    this.totalCountSpan.textContent = stats.total || 0;
                    this.successCountSpan.textContent = stats.success || 0;
                    this.todayCountSpan.textContent = stats.today || 0;
                    this.storageSizeSpan.textContent = this.formatFileSize(stats.storage_size || 0);
                } catch (error) {
                    console.error('更新统计数据失败:', error);
                }
            }

            async viewRecord(id) {
                window.open(`/library/${id}`, '_blank');
            }

            async downloadRecord(id) {
                try {
                    const response = await fetch(`/api/library/${id}/download`);
                    if (!response.ok) throw new Error('下载失败');
                    
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `translation-${id}.html`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    this.showError('下载失败: ' + error.message);
                }
            }

            async deleteRecord(id) {
                if (!confirm('确定要删除这条记录吗？此操作不可撤销。')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/library/${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('删除失败');
                    
                    this.loadData();
                    this.updateStats();
                    this.showSuccess('记录已删除');
                } catch (error) {
                    this.showError('删除失败: ' + error.message);
                }
            }

            async deleteSelected() {
                if (this.selectedItems.size === 0) {
                    this.showError('请先选择要删除的记录');
                    return;
                }
                
                if (!confirm(`确定要删除选中的 ${this.selectedItems.size} 条记录吗？此操作不可撤销。`)) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/library/batch-delete', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: Array.from(this.selectedItems) })
                    });
                    
                    if (!response.ok) throw new Error('批量删除失败');
                    
                    this.selectedItems.clear();
                    this.loadData();
                    this.updateStats();
                    this.showSuccess('记录已删除');
                } catch (error) {
                    this.showError('批量删除失败: ' + error.message);
                }
            }

            async exportSelected() {
                if (this.selectedItems.size === 0) {
                    this.showError('请先选择要导出的记录');
                    return;
                }
                
                try {
                    const response = await fetch('/api/library/export', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: Array.from(this.selectedItems) })
                    });
                    
                    if (!response.ok) throw new Error('导出失败');
                    
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `library-export-${new Date().toISOString().split('T')[0]}.zip`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    this.showError('导出失败: ' + error.message);
                }
            }

            getStatusText(status) {
                const statusMap = {
                    'success': '成功',
                    'pending': '处理中',
                    'error': '失败',
                    'unknown': '未知'
                };
                return statusMap[status] || '未知';
            }

            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN');
            }

            formatFileSize(bytes) {
                if (!bytes) return '0 B';
                const units = ['B', 'KB', 'MB', 'GB'];
                let size = bytes;
                let unitIndex = 0;
                
                while (size >= 1024 && unitIndex < units.length - 1) {
                    size /= 1024;
                    unitIndex++;
                }
                
                return `${size.toFixed(1)} ${units[unitIndex]}`;
            }

            truncateText(text, maxLength) {
                if (!text) return '';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            showError(message) {
                // 简单的错误提示，可以替换为更好的UI组件
                alert('错误: ' + message);
            }

            showSuccess(message) {
                // 简单的成功提示，可以替换为更好的UI组件
                console.log('成功: ' + message);
            }
        }

        // 初始化库管理器
        let libraryManager;
        document.addEventListener('DOMContentLoaded', () => {
            libraryManager = new LibraryManager();
        });
    </script>
</body>
</html>